<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lantern Admin</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --muted:#93a4c7; --text:#e9f0ff; --line:#213055;
      --good:#2ee59d; --warn:#ffb020; --bad:#ff4d6d; --shadow:0 8px 24px rgba(0,0,0,.35); --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, rgba(70,110,255,.28), transparent 55%),
                  radial-gradient(900px 450px at 90% -20%, rgba(46,229,157,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 120px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:10px 0 16px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px;font-weight:780}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;border-radius:999px;
      display:flex;gap:10px;align-items:center;white-space:nowrap;
      box-shadow: var(--shadow);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .dot.good{background:var(--good)} .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 880px){ .grid{grid-template-columns:360px 1fr;align-items:start} }
    .card{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card h2{margin:0;font-size:14px;letter-spacing:.2px;font-weight:780}
    .card .bd{padding:14px}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      background: rgba(8,12,22,.7);
      border: 1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius: 12px;
      padding: 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(156,194,255,.55);
      box-shadow: 0 0 0 4px rgba(156,194,255,.10);
    }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:520px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }
    .btnbar{display:flex;flex-wrap:wrap;gap:10px}
    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 750;
      cursor:pointer;
      width:100%;
      min-height:44px;
    }
    button.secondary{background: rgba(255,255,255,.03)}
    button.good{border-color: rgba(46,229,157,.45)}
    button.warn{border-color: rgba(255,176,32,.50)}
    button.bad{border-color: rgba(255,77,109,.55)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .tiny{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;padding:2px 6px;border:1px solid rgba(255,255,255,.14);
      border-radius: 8px;background: rgba(255,255,255,.03);color:#d8e6ff;
    }
    .sticky{
      position:fixed;left:0;right:0;bottom:0;
      background: rgba(7,10,18,.78);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .sticky .inner{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .sticky button{border-radius:16px;padding:12px 10px;font-size:13px}
    .log{display:flex;flex-direction:column;gap:10px}
    .entry{border:1px solid rgba(255,255,255,.10);background: rgba(0,0,0,.18);border-radius: 14px;padding: 10px 12px}
    .entry .top{display:flex;justify-content:space-between;gap:10px;align-items:baseline;margin-bottom:6px}
    .tag{font-size:11px;color: var(--muted);display:inline-flex;gap:6px;align-items:center}
    .tag b{color: var(--text);font-weight: 820}
    .entry pre{margin:0;white-space:pre-wrap;word-break:break-word;color:#dbe7ff;font-size:12.5px;line-height:1.35}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{font-size:12px;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;background: rgba(255,255,255,.03);color:#dbe7ff}
    .divider{height:1px;background: rgba(255,255,255,.08);margin:14px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Lantern Admin</h1>
        <p>Topics: <span class="kbd">lantern-message-ROOM</span> ¬∑ <span class="kbd">lantern-command-ROOM</span> ¬∑ <span class="kbd">lantern-clientresponse-ROOM</span></p>
      </div>
      <div class="pill" title="Listener / auth status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText" style="font-size:13px;color:var(--muted)">Idle</span>
      </div>
    </header>

    <div class="grid">
      <!-- Settings -->
      <section class="card">
        <div class="hd">
          <h2>Settings</h2>
          <div class="btnbar" style="width:auto">
            <button class="secondary" id="btnClear" type="button" style="width:auto">Clear</button>
          </div>
        </div>
        <div class="bd">
          <label for="baseUrl">ntfy Base URL</label>
          <input id="baseUrl" type="url" placeholder="https://ntfy.kisrani.com" />

          <div class="row two">
            <div>
              <label for="username">Username</label>
              <input id="username" autocomplete="username" placeholder="ntfy user" />
            </div>
            <div>
              <label for="password">Password</label>
              <input id="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <label for="room">Room (4 chars)</label>
          <input id="room" inputmode="text" maxlength="4" placeholder="CB32" />

          <div class="row two">
            <button class="secondary" id="btnStartListen" type="button">Start Listening</button>
            <button class="secondary" id="btnStopListen" type="button" disabled>Stop Listening</button>
          </div>

          <div class="row two">
            <button class="secondary" id="btnVerify" type="button">Verify Auth</button>
            <button class="secondary" id="btnCopyTopics" type="button">Copy Topics</button>
          </div>

          <div class="tiny">
            Listener connects to <span class="kbd">/lantern-clientresponse-ROOM/json</span> and parses newline-delimited JSON.
          </div>
        </div>
      </section>

      <!-- Send -->
      <section class="card">
        <div class="hd">
          <h2>Send</h2>
          <div class="row two" style="width:220px">
            <select id="sendMode" aria-label="Send mode">
              <option value="command">Command</option>
              <option value="message">Message topic</option>
            </select>
          </div>
        </div>

        <!-- COMMAND PANEL -->
        <div class="bd" id="panelCommand">
          <div class="row two">
            <div>
              <label for="cmd">Command</label>
              <select id="cmd">
                <optgroup label="Core session control">
                  <option value="lock">lock</option>
                  <option value="unlock">unlock</option>
                  <option value="end">end</option>
                </optgroup>
                <optgroup label="Navigation control">
                  <option value="focus">focus</option>
                  <option value="open">open</option>
                  <option value="lock_focus">lock_focus</option>
                </optgroup>
                <optgroup label="Presenter messaging">
                  <option value="announce">announce</option>
                </optgroup>
                <optgroup label="Countdown">
                  <option value="countdown">countdown</option>
                </optgroup>
                <optgroup label="Noise control">
                  <option value="mute">mute</option>
                  <option value="unmute">unmute</option>
                </optgroup>
                <optgroup label="Soft control">
                  <option value="freeze">freeze</option>
                  <option value="resume">resume</option>
                </optgroup>
                <optgroup label="Tab cleanup">
                  <option value="close_tabs">close_tabs</option>
                </optgroup>
                <optgroup label="Diagnostics / admin sync">
                  <option value="ping">ping</option>
                  <option value="version">version</option>
                  <option value="state">state</option>
                </optgroup>
                <optgroup label="Whitelist control">
                  <option value="whitelist_add">whitelist_add</option>
                  <option value="whitelist_clear">whitelist_clear</option>
                </optgroup>
              </select>
            </div>

            <div>
              <label for="cmdId">id</label>
              <input id="cmdId" placeholder="auto-generated if blank" />
            </div>
          </div>

          <div id="argsArea"></div>

          <div class="chips" id="cmdHints"></div>

          <div class="btnbar" style="margin-top:12px">
            <button class="good" id="btnSendCommand" type="button">Send Command</button>
          </div>

          <div class="tiny">
            Posts JSON to <span class="kbd">lantern-command-ROOM</span>:
            <span class="kbd">{cmd,id,args}</span>
          </div>
        </div>

        <!-- MESSAGE PANEL (ntfy publish fields) -->
        <div class="bd" id="panelMessage" style="display:none">
          <div class="row two">
            <div>
              <label for="ntfyTitle">title (optional)</label>
              <input id="ntfyTitle" placeholder="Welcome" />
            </div>
            <div>
              <label for="ntfyClick">click (optional)</label>
              <input id="ntfyClick" type="url" placeholder="https://example.com" />
            </div>
          </div>

          <label for="ntfyMessage">message (required)</label>
          <textarea id="ntfyMessage" placeholder="We‚Äôll begin shortly."></textarea>

          <div class="row two">
            <div>
              <label for="ntfyAttach">attach / image URL (optional)</label>
              <input id="ntfyAttach" type="url" placeholder="https://example.com/image.png" />
            </div>
            <div>
              <label for="ntfyPriority">priority (optional)</label>
              <select id="ntfyPriority">
                <option value="">(default)</option>
                <option value="1">1 - min</option>
                <option value="2">2 - low</option>
                <option value="3">3 - default</option>
                <option value="4">4 - high</option>
                <option value="5">5 - max</option>
              </select>
            </div>
          </div>

          <div class="row two">
            <div>
              <label for="ntfyTags">tags (optional, comma-separated)</label>
              <input id="ntfyTags" placeholder="lantern,info" />
            </div>
            <div>
              <label for="ntfyDelay">delay (optional)</label>
              <input id="ntfyDelay" placeholder="10s or 2026-01-08T18:00:00" />
            </div>
          </div>

          <div class="btnbar" style="margin-top:12px">
            <button class="good" id="btnSendMessage" type="button">Send Message</button>
          </div>

          <div class="tiny">
            Publishes using ntfy parameters to <span class="kbd">lantern-message-ROOM</span> as
            <span class="kbd">application/x-www-form-urlencoded</span> (title/message/click/attach/etc).
          </div>
        </div>
      </section>

      <!-- Activity -->
      <section class="card" style="grid-column:1/-1">
        <div class="hd">
          <h2>Activity</h2>
          <div class="right">
            <button class="secondary" id="btnClearLog" type="button" style="width:auto">Clear Log</button>
          </div>
        </div>
        <div class="bd">
          <div class="log" id="log"></div>
          <div class="tiny" id="emptyLogHint" style="display:none">No activity yet. Send something spicy üå∂Ô∏è</div>
        </div>
      </section>
    </div>
  </div>

  <div class="sticky" aria-label="Quick actions">
    <div class="inner">
      <button class="warn" id="stickyLock" type="button">Lock</button>
      <button class="good" id="stickyUnlock" type="button">Unlock</button>
      <button class="bad" id="stickyEnd" type="button">End</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // topics
    function normalizeRoom(room){ return (room||"").trim().toUpperCase(); }
    function validateRoom(room){ return /^[A-Z0-9]{4}$/.test(room); }
    function topic(type, room){ return `lantern-${type}-${room}`; }

    function getBaseUrl(){ return ($("baseUrl").value.trim() || "https://ntfy.kisrani.com").replace(/\/+$/,""); }
    function getCreds(){ return { username: $("username").value, password: $("password").value }; }
    function getRoom(){ return normalizeRoom($("room").value); }

    function basicAuthHeader(username, password){ return "Basic " + btoa(`${username}:${password}`); }

    function nowStamp(){ return new Date().toLocaleString(undefined, { hour12: true }); }

    function setStatus(state, text){
      const dot = $("statusDot");
      dot.classList.remove("good","bad");
      if (state === "good") dot.classList.add("good");
      if (state === "bad") dot.classList.add("bad");
      $("statusText").textContent = text;
    }

    function logEntry(kind, details, ok=true){
      const el = document.createElement("div");
      el.className = "entry";
      const top = document.createElement("div");
      top.className = "top";

      const left = document.createElement("div");
      left.className = "tag";
      left.innerHTML = `<b>${kind}</b> ¬∑ ${nowStamp()} ¬∑ <span style="color:${ok ? "var(--good)" : "var(--bad)"}">${ok ? "OK" : "FAIL"}</span>`;

      const right = document.createElement("div");
      right.className = "tag";
      right.textContent = validateRoom(getRoom()) ? `room ${getRoom()}` : "no room";

      top.appendChild(left);
      top.appendChild(right);

      const pre = document.createElement("pre");
      pre.textContent = details;

      el.appendChild(top);
      el.appendChild(pre);

      const log = $("log");
      log.prepend(el);
      $("emptyLogHint").style.display = log.children.length ? "none" : "block";
    }

    function save(){
      const data = {
        baseUrl: $("baseUrl").value.trim(),
        username: $("username").value,
        password: $("password").value,
        room: normalizeRoom($("room").value),
        sendMode: $("sendMode").value,
        cmd: $("cmd").value,
        // message fields
        ntfyTitle: $("ntfyTitle").value,
        ntfyMessage: $("ntfyMessage").value,
        ntfyClick: $("ntfyClick").value,
        ntfyAttach: $("ntfyAttach").value,
        ntfyPriority: $("ntfyPriority").value,
        ntfyTags: $("ntfyTags").value,
        ntfyDelay: $("ntfyDelay").value,
      };
      localStorage.setItem("lanternAdmin", JSON.stringify(data));
    }

    function load(){
      try{
        const raw = localStorage.getItem("lanternAdmin");
        if (!raw) return;
        const d = JSON.parse(raw);
        if (d.baseUrl) $("baseUrl").value = d.baseUrl;
        if (d.username) $("username").value = d.username;
        if (d.password) $("password").value = d.password;
        if (d.room) $("room").value = d.room;
        if (d.sendMode) $("sendMode").value = d.sendMode;
        if (d.cmd) $("cmd").value = d.cmd;
        if (d.ntfyTitle) $("ntfyTitle").value = d.ntfyTitle;
        if (d.ntfyMessage) $("ntfyMessage").value = d.ntfyMessage;
        if (d.ntfyClick) $("ntfyClick").value = d.ntfyClick;
        if (d.ntfyAttach) $("ntfyAttach").value = d.ntfyAttach;
        if (d.ntfyPriority) $("ntfyPriority").value = d.ntfyPriority;
        if (d.ntfyTags) $("ntfyTags").value = d.ntfyTags;
        if (d.ntfyDelay) $("ntfyDelay").value = d.ntfyDelay;
      }catch{}
    }

    function clearSaved(){
      localStorage.removeItem("lanternAdmin");
      $("username").value = "";
      $("password").value = "";
      $("room").value = "";
      setStatus("warn", "Idle");
    }

    function requireReady(){
      const baseUrl = getBaseUrl();
      const {username, password} = getCreds();
      const room = getRoom();
      if (!baseUrl.startsWith("http")) throw new Error("Base URL must start with http(s).");
      if (!username || !password) throw new Error("Username + password required.");
      if (!validateRoom(room)) throw new Error("Room must be 4 letters/numbers.");
      return { baseUrl, username, password, room };
    }

    function genId(){
      return (Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,6)).toUpperCase();
    }

    async function postJson(topicName, payload){
      const { baseUrl, username, password } = requireReady();
      const url = `${baseUrl}/${encodeURIComponent(topicName)}`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": basicAuthHeader(username, password),
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      const text = await res.text().catch(()=> "");
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}${text ? `\n\n${text}` : ""}`);
      return { status: res.status, responseText: text };
    }

    // ntfy publish params (form-encoded) to message topic
    async function postNtfyForm(topicName, paramsObj){
      const { baseUrl, username, password } = requireReady();
      const url = `${baseUrl}/${encodeURIComponent(topicName)}`;
      const form = new URLSearchParams();
      for (const [k,v] of Object.entries(paramsObj)){
        if (v === undefined || v === null) continue;
        const s = String(v).trim();
        if (!s) continue;
        form.set(k, s);
      }

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": basicAuthHeader(username, password),
          "Content-Type": "application/x-www-form-urlencoded; charset=utf-8"
        },
        body: form.toString()
      });

      const text = await res.text().catch(()=> "");
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}${text ? `\n\n${text}` : ""}`);
      return { status: res.status, responseText: text, body: form.toString() };
    }

    // ---- streaming listener ----
    let abortListen = null;
    let listenActive = false;

    function setListenButtons(){
      $("btnStartListen").disabled = listenActive;
      $("btnStopListen").disabled = !listenActive;
    }

    async function startListening(){
      const { baseUrl, username, password, room } = requireReady();
      const t = topic("clientresponse", room);
      const url = `${baseUrl}/${encodeURIComponent(t)}/json`;

      if (abortListen) abortListen.abort();
      abortListen = new AbortController();
      listenActive = true;
      setListenButtons();
      setStatus("warn", "Listening‚Ä¶");

      logEntry("LISTEN", `Connecting: ${t}/json`, true);

      try{
        const res = await fetch(url, {
          method: "GET",
          headers: { "Authorization": basicAuthHeader(username, password) },
          signal: abortListen.signal
        });

        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

        setStatus("good", "Listening (connected)");

        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buf = "";

        while(true){
          const { value, done } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });

          let idx;
          while ((idx = buf.indexOf("\n")) >= 0){
            const line = buf.slice(0, idx).trim();
            buf = buf.slice(idx + 1);
            if (!line) continue;

            try{
              const obj = JSON.parse(line);
              logEntry("RESPONSE", JSON.stringify(obj, null, 2), true);
            }catch{
              logEntry("RESPONSE", line, true);
            }
          }
        }

        if (!abortListen.signal.aborted){
          setStatus("bad", "Listener ended");
          logEntry("LISTEN", "Stream ended (server closed connection).", false);
        }
      }catch(err){
        if (abortListen?.signal?.aborted){
          setStatus("warn", "Idle");
          logEntry("LISTEN", "Disconnected (stopped).", true);
        }else{
          setStatus("bad", "Listen failed");
          logEntry("LISTEN", String(err.message || err), false);
        }
      }finally{
        listenActive = false;
        setListenButtons();
      }
    }

    function stopListening(){ if (abortListen) abortListen.abort(); }

    // ---- command form schema ----
    const CMD_SCHEMA = {
      lock: { hints:["No args","Response: ack (if id present)"], fields: [] },
      unlock: { hints:["No args","Response: ack"], fields: [] },
      end: { hints:["No args","Response: ended on clientresponse"], fields: [] },

      focus: {
        hints:['Navigate active tab to url','Response: ack with focused'],
        fields: [{ key:"url", label:"URL", type:"url", required:true, placeholder:"https://example.com" }]
      },
      open: {
        hints:['Open new tab to url','Response: ack with opened'],
        fields: [
          { key:"url", label:"URL", type:"url", required:true, placeholder:"https://example.com" },
          { key:"active", label:"Active tab?", type:"bool", required:false, default:true }
        ]
      },
      lock_focus: {
        hints:['Focus everyone to url then lock','Response: ack with lockFocused'],
        fields: [{ key:"url", label:"URL", type:"url", required:true, placeholder:"https://lantern.kisrani.com/wait" }]
      },

      announce: {
        hints:['Shows Lantern notification (independent of message topic)','Response: ack'],
        fields: [
          { key:"title", label:"Title", type:"text", required:false, placeholder:"Lantern" },
          { key:"message", label:"Message", type:"textarea", required:true, placeholder:"Eyes up ‚Äî quick demo." }
        ]
      },

      countdown: {
        hints:['Countdown end = now + seconds','Response includes countdownEnd + countdownLabel'],
        fields: [
          { key:"seconds", label:"Seconds", type:"number", required:true, placeholder:"120", min:1 },
          { key:"label", label:"Label", type:"text", required:false, placeholder:"Quick demo" }
        ]
      },

      mute: { hints:['Suppresses lantern-message-ROOM notifications only'], fields: [] },
      unmute: { hints:['Re-enable lantern-message-ROOM notifications'], fields: [] },

      freeze: { hints:['Blocks new tabs + blocks navigation unless whitelisted'], fields: [] },
      resume: { hints:['Restore normal navigation'], fields: [] },

      close_tabs: {
        hints:['Closes tabs opened during scope','keepPinned defaults true'],
        fields: [
          { key:"scope", label:"Scope", type:"select", required:true, options:[
            {v:"session", t:"session (since join)"},
            {v:"lock", t:"lock (since lock started)"},
            {v:"all", t:"all (union)"}
          ], default:"session" },
          { key:"keepPinned", label:"Keep pinned tabs?", type:"bool", required:false, default:true }
        ]
      },

      ping: { hints:['Client responds with pong'], fields: [] },
      version: { hints:['Client responds with version info'], fields: [] },
      state: { hints:['Client responds with state snapshot'], fields: [] },

      whitelist_add: {
        hints:['Adds allowed domains (freeze only)','Exact host or subdomain match'],
        fields: [
          { key:"domains", label:"Domains (comma-separated)", type:"csv", required:true, placeholder:"example.com, lantern.kisrani.com" }
        ]
      },
      whitelist_clear: { hints:['Clears whitelist'], fields: [] }
    };

    function showPanel(mode){
      $("panelCommand").style.display = mode === "command" ? "block" : "none";
      $("panelMessage").style.display = mode === "message" ? "block" : "none";
    }

    function renderCmdHints(){
      const cmd = $("cmd").value;
      const hints = (CMD_SCHEMA[cmd]?.hints || []);
      const box = $("cmdHints");
      box.innerHTML = "";
      for (const h of hints){
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = h;
        box.appendChild(el);
      }
    }

    function renderArgsForm(){
      const cmd = $("cmd").value;
      const schema = CMD_SCHEMA[cmd] || { fields: [] };
      const area = $("argsArea");
      area.innerHTML = "";

      if (!schema.fields.length){
        const p = document.createElement("div");
        p.className = "tiny";
        p.textContent = "No args for this command.";
        area.appendChild(p);
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "divider";
      area.appendChild(wrap);

      for (const f of schema.fields){
        const id = `arg_${cmd}_${f.key}`;

        const lab = document.createElement("label");
        lab.htmlFor = id;
        lab.textContent = f.label + (f.required ? " (required)" : " (optional)");
        area.appendChild(lab);

        let input;
        if (f.type === "textarea"){
          input = document.createElement("textarea");
          input.placeholder = f.placeholder || "";
        } else if (f.type === "select"){
          input = document.createElement("select");
          for (const opt of f.options){
            const o = document.createElement("option");
            o.value = opt.v; o.textContent = opt.t;
            input.appendChild(o);
          }
          if (f.default !== undefined) input.value = f.default;
        } else if (f.type === "bool"){
          input = document.createElement("select");
          input.innerHTML = `<option value="true">true</option><option value="false">false</option>`;
          input.value = (f.default === false) ? "false" : "true";
        } else {
          input = document.createElement("input");
          input.type = (f.type === "number") ? "number" : (f.type === "url" ? "url" : "text");
          input.placeholder = f.placeholder || "";
          if (f.type === "number" && f.min !== undefined) input.min = String(f.min);
          if (f.default !== undefined && f.default !== null) input.value = String(f.default);
        }

        input.id = id;
        input.dataset.argKey = f.key;
        input.dataset.argType = f.type;
        input.dataset.required = f.required ? "1" : "0";

        // layout niceness: group small fields in rows when possible
        area.appendChild(input);
      }
    }

    function readArgsFromForm(){
      const cmd = $("cmd").value;
      const schema = CMD_SCHEMA[cmd] || { fields: [] };
      if (!schema.fields.length) return undefined;

      const args = {};
      for (const f of schema.fields){
        const el = document.querySelector(`#arg_${cmd}_${f.key}`);
        if (!el) continue;

        let raw = (el.value ?? "").toString().trim();

        if (f.required && !raw){
          throw new Error(`Missing required arg: ${f.key}`);
        }
        if (!raw && !f.required) continue;

        if (f.type === "number"){
          const n = Number(raw);
          if (!Number.isFinite(n)) throw new Error(`Arg ${f.key} must be a number`);
          args[f.key] = n;
        } else if (f.type === "bool"){
          args[f.key] = (raw === "true");
        } else if (f.type === "csv"){
          const parts = raw.split(",").map(s=>s.trim()).filter(Boolean);
          if (f.required && !parts.length) throw new Error(`Arg ${f.key} must contain at least one value`);
          args[f.key] = parts;
        } else {
          args[f.key] = raw;
        }
      }
      return Object.keys(args).length ? args : undefined;
    }

    async function verifyAuth(){
      // Uses ntfy form publish to message topic (so it matches your requested syntax).
      const { room } = requireReady();
      const t = topic("message", room);

      const params = {
        title: "Lantern Admin",
        message: "Auth verified (test publish)."
      };

      const out = await postNtfyForm(t, params);
      return { topic: t, status: out.status };
    }

    function copyTopics(){
      const room = getRoom();
      if (!validateRoom(room)) throw new Error("Enter a valid 4-char room first.");
      const lines = [
        topic("message", room),
        topic("command", room),
        topic("clientresponse", room)
      ].join("\n");
      navigator.clipboard.writeText(lines);
      logEntry("COPY", lines, true);
    }

    // ---- init ----
    load();
    $("baseUrl").value = $("baseUrl").value.trim() || "https://ntfy.kisrani.com";
    $("room").value = normalizeRoom($("room").value).slice(0,4);
    showPanel($("sendMode").value);
    $("emptyLogHint").style.display = $("log").children.length ? "none" : "block";
    setStatus("warn","Idle");

    renderCmdHints();
    renderArgsForm();

    // persist changes
    ["baseUrl","username","password","room","sendMode","cmd","cmdId",
     "ntfyTitle","ntfyMessage","ntfyClick","ntfyAttach","ntfyPriority","ntfyTags","ntfyDelay"
    ].forEach(id=>{
      $(id).addEventListener("input", save);
      $(id).addEventListener("change", save);
    });

    $("room").addEventListener("input", (e)=>{ e.target.value = normalizeRoom(e.target.value).slice(0,4); });

    $("sendMode").addEventListener("change", (e)=> showPanel(e.target.value));

    $("cmd").addEventListener("change", ()=>{
      renderCmdHints();
      renderArgsForm();
      save();
    });

    $("btnClear").addEventListener("click", ()=>{
      if (confirm("Clear saved settings (credentials + room) on this device?")){
        stopListening();
        clearSaved();
        save();
      }
    });

    $("btnClearLog").addEventListener("click", ()=>{
      $("log").innerHTML = "";
      $("emptyLogHint").style.display = "block";
    });

    $("btnCopyTopics").addEventListener("click", ()=>{
      try { copyTopics(); }
      catch(err){ logEntry("COPY", String(err.message || err), false); }
    });

    $("btnVerify").addEventListener("click", async ()=>{
      try{
        setStatus("warn","Verifying‚Ä¶");
        const out = await verifyAuth();
        setStatus("good", `Auth OK (${out.status})`);
        logEntry("VERIFY", `Published test message to ${out.topic}`, true);
      }catch(err){
        setStatus("bad","Auth failed");
        logEntry("VERIFY", String(err.message || err), false);
      }
    });

    $("btnStartListen").addEventListener("click", async ()=>{
      try{ await startListening(); }
      catch(err){ logEntry("LISTEN", String(err.message||err), false); }
    });

    $("btnStopListen").addEventListener("click", ()=> stopListening());

    $("btnSendCommand").addEventListener("click", async ()=>{
      try{
        const { room } = requireReady();
        const t = topic("command", room);

        const cmd = $("cmd").value;
        const id = ($("cmdId").value.trim() || genId());

        const args = readArgsFromForm();
        const payload = { cmd, id };
        if (args !== undefined) payload.args = args;

        const out = await postJson(t, payload);
        setStatus("good","Sent");
        logEntry("COMMAND", `POST ${t}\n\n${JSON.stringify(payload, null, 2)}`, true);
      }catch(err){
        setStatus("bad","Send failed");
        logEntry("COMMAND", String(err.message || err), false);
      }
    });

    $("btnSendMessage").addEventListener("click", async ()=>{
      try{
        const { room } = requireReady();
        const t = topic("message", room);

        const message = $("ntfyMessage").value.trim();
        if (!message) throw new Error("message is required.");

        // ntfy publish parameters (form fields)
        const params = {
          title: $("ntfyTitle").value,
          message,
          click: $("ntfyClick").value,
          attach: $("ntfyAttach").value,
          priority: $("ntfyPriority").value,
          tags: $("ntfyTags").value,
          delay: $("ntfyDelay").value,
        };

        const out = await postNtfyForm(t, params);
        setStatus("good","Sent");
        logEntry("MESSAGE", `POST ${t}\n\n${out.body}`, true);
      }catch(err){
        setStatus("bad","Send failed");
        logEntry("MESSAGE", String(err.message || err), false);
      }
    });

    // Sticky quick actions
    async function quick(cmd){
      $("sendMode").value = "command";
      showPanel("command");
      $("cmd").value = cmd;
      renderCmdHints();
      renderArgsForm();
      $("cmdId").value = "";
      save();
      $("btnSendCommand").click();
    }
    $("stickyLock").addEventListener("click", ()=>quick("lock"));
    $("stickyUnlock").addEventListener("click", ()=>quick("unlock"));
    $("stickyEnd").addEventListener("click", ()=>quick("end"));

    // ---- streaming listener implementation ----
    async function startListening(){
      const { baseUrl, username, password, room } = requireReady();
      const t = topic("clientresponse", room);
      const url = `${baseUrl}/${encodeURIComponent(t)}/json`;

      if (abortListen) abortListen.abort();
      abortListen = new AbortController();
      listenActive = true;
      setListenButtons();
      setStatus("warn", "Listening‚Ä¶");

      logEntry("LISTEN", `Connecting: ${t}/json`, true);

      try{
        const res = await fetch(url, {
          method: "GET",
          headers: { "Authorization": basicAuthHeader(username, password) },
          signal: abortListen.signal
        });

        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

        setStatus("good", "Listening (connected)");

        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buf = "";

        while(true){
          const { value, done } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });

          let idx;
          while ((idx = buf.indexOf("\n")) >= 0){
            const line = buf.slice(0, idx).trim();
            buf = buf.slice(idx + 1);
            if (!line) continue;

            try{
              const obj = JSON.parse(line);
              logEntry("RESPONSE", JSON.stringify(obj, null, 2), true);
            }catch{
              logEntry("RESPONSE", line, true);
            }
          }
        }

        if (!abortListen.signal.aborted){
          setStatus("bad", "Listener ended");
          logEntry("LISTEN", "Stream ended (server closed connection).", false);
        }
      }catch(err){
        if (abortListen?.signal?.aborted){
          setStatus("warn", "Idle");
          logEntry("LISTEN", "Disconnected (stopped).", true);
        }else{
          setStatus("bad", "Listen failed");
          logEntry("LISTEN", String(err.message || err), false);
        }
      }finally{
        listenActive = false;
        setListenButtons();
      }
    }

    function setListenButtons(){
      $("btnStartListen").disabled = listenActive;
      $("btnStopListen").disabled = !listenActive;
    }

    function stopListening(){ if (abortListen) abortListen.abort(); }

  </script>
</body>
</html>
