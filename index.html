<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lantern Admin</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --card:#101a2e; --muted:#93a4c7; --text:#e9f0ff;
      --line:#213055; --good:#2ee59d; --warn:#ffb020; --bad:#ff4d6d;
      --shadow: 0 8px 24px rgba(0,0,0,.35); --r:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% -10%, rgba(70,110,255,.28), transparent 55%),
                  radial-gradient(900px 450px at 90% -20%, rgba(46,229,157,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px 16px 120px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:10px 0 16px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px;font-weight:780}
    .brand p{margin:0;color:var(--muted);font-size:13px}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;border-radius:999px;
      display:flex;gap:10px;align-items:center;white-space:nowrap;
      box-shadow: var(--shadow);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--warn)}
    .dot.good{background:var(--good)} .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 880px){ .grid{grid-template-columns:360px 1fr;align-items:start} }
    .card{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card h2{margin:0;font-size:14px;letter-spacing:.2px;font-weight:780}
    .card .bd{padding:14px}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      background: rgba(8,12,22,.7);
      border: 1px solid rgba(255,255,255,.12);
      color:var(--text);
      border-radius: 12px;
      padding: 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color: rgba(156,194,255,.55);
      box-shadow: 0 0 0 4px rgba(156,194,255,.10);
    }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:520px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }
    .btnbar{display:flex;flex-wrap:wrap;gap:10px}
    button{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      color:var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 750;
      cursor:pointer;
      width:100%;
      min-height:44px;
    }
    button.secondary{background: rgba(255,255,255,.03)}
    button.good{border-color: rgba(46,229,157,.45)}
    button.warn{border-color: rgba(255,176,32,.50)}
    button.bad{border-color: rgba(255,77,109,.55)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .tiny{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;padding:2px 6px;border:1px solid rgba(255,255,255,.14);
      border-radius: 8px;background: rgba(255,255,255,.03);color:#d8e6ff;
    }
    .sticky{
      position:fixed;left:0;right:0;bottom:0;
      background: rgba(7,10,18,.78);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .sticky .inner{
      max-width: 980px;margin:0 auto;
      display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;
    }
    .sticky button{border-radius:16px;padding:12px 10px;font-size:13px}
    .log{display:flex;flex-direction:column;gap:10px}
    .entry{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .entry .top{display:flex;justify-content:space-between;gap:10px;align-items:baseline;margin-bottom:6px}
    .tag{font-size:11px;color: var(--muted);display:inline-flex;gap:6px;align-items:center}
    .tag b{color: var(--text);font-weight: 820}
    .entry pre{margin:0;white-space:pre-wrap;word-break:break-word;color:#dbe7ff;font-size:12.5px;line-height:1.35}
    .right{display:flex;gap:10px;align-items:center}
    .iconbtn{width:auto;padding:10px 12px;border-radius:12px;background: rgba(255,255,255,.03)}
    .hintline{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .chip{
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:6px 10px;
      background: rgba(255,255,255,.03);
      color:#dbe7ff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Lantern Admin</h1>
        <p>Topics: <span class="kbd">lantern-message-ROOM</span> ¬∑ <span class="kbd">lantern-command-ROOM</span> ¬∑ <span class="kbd">lantern-clientresponse-ROOM</span></p>
      </div>
      <div class="pill" id="statusPill" title="Listener / auth status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText" style="font-size:13px;color:var(--muted)">Idle</span>
      </div>
    </header>

    <div class="grid">

      <!-- Settings -->
      <section class="card">
        <div class="hd">
          <h2>Settings</h2>
          <div class="right">
            <button class="iconbtn secondary" id="btnClear" type="button" title="Clear saved credentials & room">Clear</button>
          </div>
        </div>
        <div class="bd">
          <label for="baseUrl">ntfy Base URL</label>
          <input id="baseUrl" type="url" placeholder="https://ntfy.kisrani.com" />

          <div class="row two">
            <div>
              <label for="username">Username</label>
              <input id="username" autocomplete="username" placeholder="ntfy user" />
            </div>
            <div>
              <label for="password">Password</label>
              <input id="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <label for="room">Room (4 chars)</label>
          <input id="room" inputmode="text" maxlength="4" placeholder="CB32" />

          <div class="row two">
            <button class="secondary" id="btnStartListen" type="button">Start Listening</button>
            <button class="secondary" id="btnStopListen" type="button" disabled>Stop Listening</button>
          </div>

          <div class="row two">
            <button class="secondary" id="btnVerify" type="button">Verify Auth</button>
            <button class="secondary" id="btnCopyTopics" type="button">Copy Topics</button>
          </div>

          <div class="tiny">
            This page will open a streaming connection to
            <span class="kbd">/lantern-clientresponse-ROOM/json</span>.
            If your server doesn‚Äôt allow auth on stream endpoints, tell me and I‚Äôll swap it to token query or no-auth.
          </div>
        </div>
      </section>

      <!-- Send -->
      <section class="card">
        <div class="hd">
          <h2>Send</h2>
          <div class="right">
            <select id="sendMode" aria-label="Send mode">
              <option value="command">Command</option>
              <option value="message">Message topic</option>
            </select>
          </div>
        </div>

        <!-- COMMAND PANEL -->
        <div class="bd" id="panelCommand">
          <div class="row two">
            <div>
              <label for="cmd">Command</label>
              <select id="cmd">
                <optgroup label="Core session control">
                  <option value="lock">lock</option>
                  <option value="unlock">unlock</option>
                  <option value="end">end</option>
                </optgroup>
                <optgroup label="Navigation control">
                  <option value="focus">focus</option>
                  <option value="open">open</option>
                  <option value="lock_focus">lock_focus</option>
                </optgroup>
                <optgroup label="Presenter messaging">
                  <option value="announce">announce</option>
                </optgroup>
                <optgroup label="Countdown">
                  <option value="countdown">countdown</option>
                </optgroup>
                <optgroup label="Noise control">
                  <option value="mute">mute</option>
                  <option value="unmute">unmute</option>
                </optgroup>
                <optgroup label="Soft control">
                  <option value="freeze">freeze</option>
                  <option value="resume">resume</option>
                </optgroup>
                <optgroup label="Tab cleanup">
                  <option value="close_tabs">close_tabs</option>
                </optgroup>
                <optgroup label="Diagnostics / admin sync">
                  <option value="ping">ping</option>
                  <option value="version">version</option>
                  <option value="state">state</option>
                </optgroup>
                <optgroup label="Whitelist control">
                  <option value="whitelist_add">whitelist_add</option>
                  <option value="whitelist_clear">whitelist_clear</option>
                </optgroup>
              </select>
            </div>

            <div>
              <label for="cmdId">id (optional but recommended)</label>
              <input id="cmdId" placeholder="auto-generated if blank" />
            </div>
          </div>

          <label for="cmdArgs">args (JSON, optional)</label>
          <textarea id="cmdArgs" placeholder='e.g. {"url":"https://example.com","active":true}'></textarea>

          <div class="hintline" id="cmdHints"></div>

          <div class="btnbar" style="margin-top:12px">
            <button class="good" id="btnSendCommand" type="button">Send Command</button>
          </div>

          <div class="tiny">
            Sends to <span class="kbd">lantern-command-ROOM</span> as JSON:
            <span class="kbd">{ "cmd":"‚Ä¶", "id":"‚Ä¶", "args":{‚Ä¶} }</span>
          </div>
        </div>

        <!-- MESSAGE PANEL -->
        <div class="bd" id="panelMessage" style="display:none">
          <div class="row two">
            <div>
              <label for="msgTitle">title (optional)</label>
              <input id="msgTitle" placeholder="Welcome" />
            </div>
            <div>
              <label for="msgClick">click URL (optional)</label>
              <input id="msgClick" type="url" placeholder="https://example.com" />
            </div>
          </div>

          <label for="msgBody">message (required)</label>
          <textarea id="msgBody" placeholder="We‚Äôll begin shortly."></textarea>

          <label for="msgImage">image URL (optional)</label>
          <input id="msgImage" type="url" placeholder="https://example.com/image.png" />

          <div class="btnbar" style="margin-top:12px">
            <button class="good" id="btnSendMessage" type="button">Send Message Topic</button>
          </div>

          <div class="tiny">
            Publishes to <span class="kbd">lantern-message-ROOM</span> using ntfy JSON fields.
          </div>
        </div>
      </section>

      <!-- Activity -->
      <section class="card" style="grid-column:1/-1">
        <div class="hd">
          <h2>Activity</h2>
          <div class="right">
            <button class="iconbtn secondary" id="btnClearLog" type="button">Clear Log</button>
          </div>
        </div>
        <div class="bd">
          <div class="log" id="log"></div>
          <div class="tiny" id="emptyLogHint" style="display:none">No activity yet. Send something spicy üå∂Ô∏è</div>
        </div>
      </section>

    </div>
  </div>

  <!-- Sticky quick actions -->
  <div class="sticky" aria-label="Quick actions">
    <div class="inner">
      <button class="warn" id="stickyLock" type="button">Lock</button>
      <button class="good" id="stickyUnlock" type="button">Unlock</button>
      <button class="bad" id="stickyPing" type="button">Ping</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // ---- topic scheme ----
    // message: lantern-message-ROOM
    // command: lantern-command-ROOM
    // client response: lantern-clientresponse-ROOM (stream at /json)
    function normalizeRoom(room){ return (room||"").trim().toUpperCase(); }
    function validateRoom(room){ return /^[A-Z0-9]{4}$/.test(room); }
    function topic(type, room){ return `lantern-${type}-${room}`; }

    function getBaseUrl(){ return ($("baseUrl").value.trim() || "https://ntfy.kisrani.com").replace(/\/+$/,""); }
    function getCreds(){ return { username: $("username").value, password: $("password").value }; }
    function getRoom(){ return normalizeRoom($("room").value); }

    function basicAuthHeader(username, password){
      return "Basic " + btoa(`${username}:${password}`);
    }

    function nowStamp(){
      const d = new Date();
      return d.toLocaleString(undefined, { hour12: true });
    }

    function setStatus(state, text){
      const dot = $("statusDot");
      dot.classList.remove("good","bad");
      if (state === "good") dot.classList.add("good");
      if (state === "bad") dot.classList.add("bad");
      $("statusText").textContent = text;
    }

    function logEntry(kind, details, ok=true){
      const el = document.createElement("div");
      el.className = "entry";
      const top = document.createElement("div");
      top.className = "top";

      const left = document.createElement("div");
      left.className = "tag";
      left.innerHTML = `<b>${kind}</b> ¬∑ ${nowStamp()} ¬∑ <span style="color:${ok ? "var(--good)" : "var(--bad)"}">${ok ? "OK" : "FAIL"}</span>`;

      const right = document.createElement("div");
      right.className = "tag";
      right.textContent = validateRoom(getRoom()) ? `room ${getRoom()}` : "no room";

      top.appendChild(left);
      top.appendChild(right);

      const pre = document.createElement("pre");
      pre.textContent = details;

      el.appendChild(top);
      el.appendChild(pre);

      const log = $("log");
      log.prepend(el);
      $("emptyLogHint").style.display = log.children.length ? "none" : "block";
    }

    function save(){
      const data = {
        baseUrl: $("baseUrl").value.trim(),
        username: $("username").value,
        password: $("password").value,
        room: normalizeRoom($("room").value),
        sendMode: $("sendMode").value,
        cmd: $("cmd").value,
        cmdArgs: $("cmdArgs").value,
      };
      localStorage.setItem("lanternAdmin", JSON.stringify(data));
    }

    function load(){
      try{
        const raw = localStorage.getItem("lanternAdmin");
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.baseUrl) $("baseUrl").value = data.baseUrl;
        if (data.username) $("username").value = data.username;
        if (data.password) $("password").value = data.password;
        if (data.room) $("room").value = data.room;
        if (data.sendMode) $("sendMode").value = data.sendMode;
        if (data.cmd) $("cmd").value = data.cmd;
        if (data.cmdArgs) $("cmdArgs").value = data.cmdArgs;
      }catch{}
    }

    function clearSaved(){
      localStorage.removeItem("lanternAdmin");
      $("username").value = "";
      $("password").value = "";
      $("room").value = "";
      setStatus("warn", "Idle");
    }

    function requireReady(){
      const baseUrl = getBaseUrl();
      const {username, password} = getCreds();
      const room = getRoom();

      if (!baseUrl.startsWith("http")) throw new Error("Base URL must start with http(s).");
      if (!username || !password) throw new Error("Username + password required.");
      if (!validateRoom(room)) throw new Error("Room must be 4 letters/numbers.");
      return { baseUrl, username, password, room };
    }

    async function postJsonToTopic(topicName, payload){
      const { baseUrl, username, password } = requireReady();
      const url = `${baseUrl}/${encodeURIComponent(topicName)}`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": basicAuthHeader(username, password),
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      const text = await res.text().catch(()=> "");
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}${text ? `\n\n${text}` : ""}`);
      return { status: res.status, responseText: text };
    }

    async function postNtfyFieldsToTopic(topicName, fields){
      const { baseUrl, username, password } = requireReady();
      const url = `${baseUrl}/${encodeURIComponent(topicName)}`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": basicAuthHeader(username, password),
          "Content-Type": "application/json"
        },
        body: JSON.stringify(fields)
      });
      const text = await res.text().catch(()=> "");
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}${text ? `\n\n${text}` : ""}`);
      return { status: res.status, responseText: text };
    }

    // ---- streaming listener to /json ----
    let abortListen = null;
    let listenActive = false;

    function setListenButtons(){
      $("btnStartListen").disabled = listenActive;
      $("btnStopListen").disabled = !listenActive;
    }

    async function startListening(){
      const { baseUrl, username, password, room } = requireReady();
      const t = topic("clientresponse", room);
      const url = `${baseUrl}/${encodeURIComponent(t)}/json`;

      if (abortListen) abortListen.abort();
      abortListen = new AbortController();
      listenActive = true;
      setListenButtons();
      setStatus("warn", "Listening‚Ä¶");

      logEntry("LISTEN", `Connecting: ${t}/json`, true);

      try{
        const res = await fetch(url, {
          method: "GET",
          headers: { "Authorization": basicAuthHeader(username, password) },
          signal: abortListen.signal
        });

        if (!res.ok){
          throw new Error(`HTTP ${res.status} ${res.statusText}`);
        }

        setStatus("good", "Listening (connected)");

        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let buf = "";

        while(true){
          const { value, done } = await reader.read();
          if (done) break;
          buf += decoder.decode(value, { stream: true });

          // ntfy JSON stream is newline-delimited JSON
          let idx;
          while ((idx = buf.indexOf("\n")) >= 0){
            const line = buf.slice(0, idx).trim();
            buf = buf.slice(idx + 1);
            if (!line) continue;

            // Sometimes it can include non-JSON keepalive lines; ignore gracefully
            try{
              const obj = JSON.parse(line);
              // Show useful fields
              logEntry("RESPONSE", JSON.stringify(obj, null, 2), true);
            }catch{
              logEntry("RESPONSE", line, true);
            }
          }
        }

        if (!abortListen.signal.aborted){
          setStatus("bad", "Listener ended");
          logEntry("LISTEN", "Stream ended (server closed connection).", false);
        }
      }catch(err){
        if (abortListen?.signal?.aborted){
          setStatus("warn", "Idle");
          logEntry("LISTEN", "Disconnected (stopped).", true);
        }else{
          setStatus("bad", "Listen failed");
          logEntry("LISTEN", String(err.message || err), false);
        }
      }finally{
        listenActive = false;
        setListenButtons();
      }
    }

    function stopListening(){
      if (abortListen) abortListen.abort();
    }

    // ---- command hints & helpers ----
    const CMD_HINTS = {
      lock: ["No args", "Response: ack (if id present)"],
      unlock: ["No args", "Response: ack"],
      end: ["No args", "Response: ended (always) on clientresponse + maybe error"],
      focus: ['args: {"url":"https://..."}', "Response: ack with focused"],
      open: ['args: {"url":"https://...","active":true}', "Response: ack with opened"],
      lock_focus: ['args: {"url":"https://..."}', "Response: ack with lockFocused"],
      announce: ['args: {"title":"Lantern","message":"..."}', "Response: ack"],
      countdown: ['args: {"seconds":120,"label":"Quick demo"}', "Response: ack includes countdownEnd + countdownLabel"],
      mute: ["No args", "Suppresses lantern-message-ROOM notifications (announce still shows)"],
      unmute: ["No args"],
      freeze: ["No args", "Blocks new tabs + blocks navigation unless whitelisted"],
      resume: ["No args"],
      close_tabs: ['args: {"scope":"session|lock|all","keepPinned":true}', "Response: ack with {closed, scope, keepPinned}"],
      ping: ["No args", 'Response: {type:"pong", room, id, ts, ok:true}'],
      version: ["No args", 'Response: {type:"version", details:{extensionVersion, protocolVersion, userAgent...}}'],
      state: ["No args", 'Response: {type:"state", details:{...}}'],
      whitelist_add: ['args: {"domains":["example.com","lantern.kisrani.com"]}', "Response: ack with updated whitelist"],
      whitelist_clear: ["No args"]
    };

    function renderCmdHints(){
      const cmd = $("cmd").value;
      const hints = CMD_HINTS[cmd] || [];
      const box = $("cmdHints");
      box.innerHTML = "";
      for (const h of hints){
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = h;
        box.appendChild(el);
      }
    }

    function genId(){
      // short, readable, good enough: base36 timestamp + random
      return (Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,6)).toUpperCase();
    }

    function showPanel(mode){
      $("panelCommand").style.display = mode === "command" ? "block" : "none";
      $("panelMessage").style.display = mode === "message" ? "block" : "none";
    }

    async function verifyAuth(){
      // Publish a harmless ping message to lantern-message-<ROOM> (your clients may show it)
      // If you want a zero-visibility verify later, we can add a dedicated admin-only topic.
      const { room } = requireReady();
      const t = topic("message", room);

      const fields = {
        title: "Lantern Admin",
        message: "Auth verified (test publish)."
      };

      const out = await postNtfyFieldsToTopic(t, fields);
      return { topic: t, status: out.status };
    }

    function copyTopics(){
      const room = getRoom();
      if (!validateRoom(room)) throw new Error("Enter a valid 4-char room first.");
      const lines = [
        topic("message", room),
        topic("command", room),
        topic("clientresponse", room)
      ].join("\n");
      navigator.clipboard.writeText(lines);
      logEntry("COPY", lines, true);
    }

    // ---- init ----
    load();
    $("baseUrl").value = $("baseUrl").value.trim() || "https://ntfy.kisrani.com";
    showPanel($("sendMode").value);
    $("emptyLogHint").style.display = $("log").children.length ? "none" : "block";
    renderCmdHints();
    setStatus("warn","Idle");

    // persist on changes
    ["baseUrl","username","password","room","sendMode","cmd","cmdArgs"].forEach(id=>{
      $(id).addEventListener("input", save);
      $(id).addEventListener("change", save);
    });
    $("room").addEventListener("input", (e)=>{
      e.target.value = normalizeRoom(e.target.value).slice(0,4);
    });

    $("sendMode").addEventListener("change", (e)=> showPanel(e.target.value));
    $("cmd").addEventListener("change", renderCmdHints);

    $("btnClear").addEventListener("click", ()=>{
      if (confirm("Clear saved settings (credentials + room) on this device?")){
        stopListening();
        clearSaved();
        save();
      }
    });

    $("btnClearLog").addEventListener("click", ()=>{
      $("log").innerHTML = "";
      $("emptyLogHint").style.display = "block";
    });

    $("btnCopyTopics").addEventListener("click", ()=>{
      try { copyTopics(); }
      catch(err){ logEntry("COPY", String(err.message || err), false); }
    });

    $("btnVerify").addEventListener("click", async ()=>{
      try{
        setStatus("warn","Verifying‚Ä¶");
        const out = await verifyAuth();
        setStatus("good", `Auth OK (${out.status})`);
        logEntry("VERIFY", `Published test message to ${out.topic}`, true);
      }catch(err){
        setStatus("bad","Auth failed");
        logEntry("VERIFY", String(err.message || err), false);
      }
    });

    $("btnStartListen").addEventListener("click", async ()=>{
      try{ await startListening(); }
      catch(err){ logEntry("LISTEN", String(err.message||err), false); }
    });

    $("btnStopListen").addEventListener("click", ()=>{
      stopListening();
    });

    $("btnSendCommand").addEventListener("click", async ()=>{
      try{
        const { room } = requireReady();
        const t = topic("command", room);

        const cmd = $("cmd").value;
        const id = ($("cmdId").value.trim() || genId());

        let args = undefined;
        const rawArgs = $("cmdArgs").value.trim();
        if (rawArgs){
          try{
            args = JSON.parse(rawArgs);
          }catch{
            throw new Error("args must be valid JSON (or leave blank).");
          }
        }

        const payload = { cmd, id };
        if (args !== undefined) payload.args = args;

        const out = await postJsonToTopic(t, payload);
        setStatus("good","Sent");
        logEntry("COMMAND", `POST ${t}\n\n${JSON.stringify(payload, null, 2)}`, true);
      }catch(err){
        setStatus("bad","Send failed");
        logEntry("COMMAND", String(err.message || err), false);
      }
    });

    $("btnSendMessage").addEventListener("click", async ()=>{
      try{
        const { room } = requireReady();
        const t = topic("message", room);

        const title = $("msgTitle").value.trim();
        const message = $("msgBody").value.trim();
        const click = $("msgClick").value.trim();
        const image = $("msgImage").value.trim();

        if (!message) throw new Error("message is required.");

        const fields = {};
        if (title) fields.title = title;
        fields.message = message;
        if (image) fields.image = image;
        if (click) fields.click = click;

        const out = await postNtfyFieldsToTopic(t, fields);
        setStatus("good","Sent");
        logEntry("MESSAGE", `POST ${t}\n\n${JSON.stringify(fields, null, 2)}`, true);
      }catch(err){
        setStatus("bad","Send failed");
        logEntry("MESSAGE", String(err.message || err), false);
      }
    });

    // Sticky quick actions: lock/unlock/ping (since end is spicy; you can swap it in)
    async function quick(cmd){
      $("sendMode").value = "command";
      showPanel("command");
      $("cmd").value = cmd;
      renderCmdHints();
      $("cmdArgs").value = "";
      $("cmdId").value = "";
      save();
      $("btnSendCommand").click();
    }
    $("stickyLock").addEventListener("click", ()=>quick("lock"));
    $("stickyUnlock").addEventListener("click", ()=>quick("unlock"));
    $("stickyPing").addEventListener("click", ()=>quick("ping"));
  </script>
</body>
</html>
